Backport of:

From de3b9cdb8521d7edd524b4e17d1e3f883f832ec0 Mon Sep 17 00:00:00 2001
From: Ingela Anderton Andin <ingela@erlang.org>
Date: Tue, 7 Nov 2017 18:34:34 +0100
Subject: [PATCH] ssl: Countermeasurements for Bleichenbacher attack

Back ported for security reasons.
Remove DTLS changes as DTLS is not at all working in OTP 18.
---
 lib/ssl/src/ssl_connection.erl | 21 +++++++++++++++++++--
 lib/ssl/src/ssl_connection.hrl |  3 ++-
 lib/ssl/src/tls_connection.erl |  1 +
 3 files changed, 22 insertions(+), 3 deletions(-)

Index: erlang-18.3-dfsg/lib/ssl/src/ssl_connection.erl
===================================================================
--- erlang-18.3-dfsg.orig/lib/ssl/src/ssl_connection.erl	2017-12-07 08:05:58.938038236 -0500
+++ erlang-18.3-dfsg/lib/ssl/src/ssl_connection.erl	2017-12-07 08:05:58.934038191 -0500
@@ -1150,8 +1150,25 @@ server_certify_and_key_exchange(State0,
     request_client_cert(State2, Connection).
 
 certify_client_key_exchange(#encrypted_premaster_secret{premaster_secret= EncPMS},
-			    #state{private_key = Key} = State, Connection) ->
-    PremasterSecret = ssl_handshake:premaster_secret(EncPMS, Key),
+			    #state{private_key = Key, client_hello_version = {Major, Minor} = Version} = State, Connection) ->
+
+    %% Countermeasure for Bleichenbacher attack always provide some kind of premaster secret
+    %% and fail handshake later.RFC 5246 section 7.4.7.1.
+    PremasterSecret =
+        try ssl_handshake:premaster_secret(EncPMS, Key) of
+            Secret when erlang:byte_size(Secret) == ?NUM_OF_PREMASTERSECRET_BYTES ->
+                case Secret of
+                    <<?BYTE(Major), ?BYTE(Minor), _/binary>> -> %% Correct
+                        Secret;
+                    <<?BYTE(_), ?BYTE(_), Rest/binary>> -> %% Version mismatch
+                        <<?BYTE(Major), ?BYTE(Minor), Rest/binary>>
+                end;
+            _ -> %% erlang:byte_size(Secret) =/= ?NUM_OF_PREMASTERSECRET_BYTES
+                make_premaster_secret(Version, rsa)
+        catch 
+            #alert{description = ?DECRYPT_ERROR} ->
+                make_premaster_secret(Version, rsa)     
+        end,        
     calculate_master_secret(PremasterSecret, State, Connection, certify, cipher);
 
 certify_client_key_exchange(#client_diffie_hellman_public{dh_public = ClientPublicDhKey},
Index: erlang-18.3-dfsg/lib/ssl/src/ssl_connection.hrl
===================================================================
--- erlang-18.3-dfsg.orig/lib/ssl/src/ssl_connection.hrl	2017-12-07 08:05:58.938038236 -0500
+++ erlang-18.3-dfsg/lib/ssl/src/ssl_connection.hrl	2017-12-07 08:05:58.934038191 -0500
@@ -54,7 +54,8 @@
 	  session_cache         :: db_handle(),
 	  session_cache_cb      :: atom(),
 	  crl_db                :: term(), 
-          negotiated_version    :: ssl_record:ssl_version(),
+          negotiated_version    :: ssl_record:ssl_version() | 'undefined',
+          client_hello_version  :: ssl_record:ssl_version() | 'undefined',
           client_certificate_requested = false :: boolean(),
 	  key_algorithm         :: ssl_cipher:key_algo(),
 	  hashsign_algorithm = {undefined, undefined},
Index: erlang-18.3-dfsg/lib/ssl/src/tls_connection.erl
===================================================================
--- erlang-18.3-dfsg.orig/lib/ssl/src/tls_connection.erl	2017-12-07 08:05:58.938038236 -0500
+++ erlang-18.3-dfsg/lib/ssl/src/tls_connection.erl	2017-12-07 08:06:31.366407691 -0500
@@ -208,6 +208,7 @@ hello(Hello = #client_hello{client_versi
             ssl_connection:hello({common_client_hello, Type, ServerHelloExt, HashSign},
 				 State#state{connection_states  = ConnectionStates,
 					     negotiated_version = Version,
+                                             client_hello_version = ClientVersion,
 					     session = Session,
 					     client_ecc = {EllipticCurves, EcPointFormats},
 					     negotiated_protocol = Protocol}, ?MODULE)
